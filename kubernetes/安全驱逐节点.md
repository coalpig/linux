

通过上节的实验我们已经掌握了如何限制Pod的调度，其实还有更简单的命令可以安全的驱逐Pod并下线Node，这条命令就是`kubectl drain`

官方地址：

https://kubernetes.io/zh/docs/tasks/administer-cluster/safely-drain-node/

说明：

在对节点执行维护（例如内核升级、硬件维护等）之前， 可以使用 kubectl drain 从节点安全地逐出所有 Pods。 安全的驱逐过程允许 Pod 的容器 体面地终止， 并确保满足指定的 PodDisruptionBudgets。

操作命令：

```
kubectl drain <nodename> 
```

执行效果：

```
[root@node1 ~]# kubectl drain node3    
node/node3 already cordoned
error: unable to drain node "node3", aborting command...

There are pending nodes to be drained:
 node3
 
cannot delete DaemonSet-managed Pods (use --ignore-daemonsets to ignore): kube-system/kube-flannel-ds-gzmxp, kube-system/kube-proxy-cfhwj, monitoring/node-exporter-4f9hz

cannot delete Pods with local storage (use --delete-local-data to override): kube-system/metrics-server-5dbcdf9f85-vx5k2, kube-system/traefik-6488cd4b75-n7dfr, monitoring/alertmanager-main-1, monitoring/grafana-6ccd8d89f8-n2wqz, monitoring/prometheus-adapter-5df846c94f-5hlhn, monitoring/prometheus-adapter-5df846c94f-5mwvx, monitoring/prometheus-k8s-0, monitoring/prometheus-k8s-1
```

这里报错了，提示我们不能执行驱逐命令，原因有2:

1.这个节点上运行DaemonSet类型的Pod，这里为kube-flannel和kube-proxy

2.这个节点上有local存储类型的Pod，这里为prometheus的组件

如果我们想继续驱逐，需要通过以下命令设置忽略DaemonSet和local存储

```
 kubectl drain node3 --ignore-daemonsets --delete-local-data
```

检查效果：

坑：这里驱逐之后提示报错,原因是因为prometheus节点必须要保持有1个在运行，但是另一个Pod还没有准备好，所以不允许被删除。解决方法就是扩容或缩容,使其满足运行的条件。

```
evicting pod monitoring/prometheus-k8s-1
error when evicting pod "prometheus-k8s-1" (will retry after 5s): Cannot evict pod as it would violate the pod's disruption budget.
evicting pod monitoring/prometheus-k8s-1
error when evicting pod "prometheus-k8s-1" (will retry after 5s): Cannot evict pod as it would violate the pod's disruption budget.
evicting pod monitoring/prometheus-k8s-1
error when evicting pod "prometheus-k8s-1" (will retry after 5s): Cannot evict pod as it would violate the pod's disruption budget.
evicting pod monitoring/prometheus-k8s-1
error when evicting pod "prometheus-k8s-1" (will retry after 5s): Cannot evict pod as it would violate the pod's disruption budget.
evicting pod monitoring/prometheus-k8s-1
error when evicting pod "prometheus-k8s-1" (will retry after 5s): Cannot evict pod as it would violate the pod's disruption budget.
```
